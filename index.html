<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureChat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #5865F2;
            --secondary-color: #3BA55C;
            --background-color: #36393F;
            --secondary-background: #2F3136;
            --third-background: #202225;
            --light-text: #FFFFFF;
            --secondary-text: #B9BBBE;
            --hover-color: #4E5D94;
            --error-color: #ED4245;
            --success-color: #3BA55C;
            --danger-color: #ED4245;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--light-text);
            height: 100vh;
            overflow: hidden;
        }

        /* Login styles */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-container {
            background-color: var(--secondary-background);
            padding: 1.5rem;
            border-radius: 8px;
            width: 90%;
            max-width: 350px;
        }

        .login-container h2 {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--secondary-text);
        }

        .form-group input {
            width: 100%;
            padding: 0.8rem;
            background-color: var(--third-background);
            border: none;
            border-radius: 4px;
            color: var(--light-text);
            font-size: 1rem;
        }

        .login-btn {
            width: 100%;
            padding: 0.8rem;
            background-color: var(--primary-color);
            color: var(--light-text);
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
        }

        .login-btn:hover {
            background-color: var(--hover-color);
        }

        .login-error {
            color: var(--error-color);
            text-align: center;
            margin-top: 1rem;
            display: none;
        }

        /* Chat container */
        #chat-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        #sidebar {
            width: 280px;
            background-color: var(--secondary-background);
            display: flex;
            flex-direction: column;
            z-index: 20;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--third-background);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h2 {
            color: var(--light-text);
        }

        .sidebar-header p {
            color: var(--secondary-text);
            font-size: 0.8rem;
        }

        .users-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem 0;
        }

        .user-item {
            display: flex;
            align-items: center;
            padding: 0.8rem 1rem;
            cursor: pointer;
        }

        .user-item:hover {
            background-color: rgba(79, 84, 92, 0.3);
        }

        .user-item.active {
            background-color: rgba(79, 84, 92, 0.6);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background-color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            margin-right: 10px;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-weight: 500;
            margin-bottom: 3px;
        }

        .user-status {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            color: var(--secondary-text);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-online {
            background-color: var(--success-color);
        }

        .status-offline {
            background-color: #747F8D;
        }

        /* Chat content */
        .chat-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            padding: 1rem;
            background-color: var(--background-color);
            border-bottom: 1px solid var(--third-background);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h1 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .chat-header .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--secondary-text);
            font-size: 1.2rem;
            cursor: pointer;
        }

        .header-controls {
            display: flex;
        }

        .header-btn {
            background: none;
            border: none;
            color: var(--secondary-text);
            font-size: 1.2rem;
            margin-left: 1rem;
            cursor: pointer;
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .date-divider {
            text-align: center;
            color: var(--secondary-text);
            font-size: 0.8rem;
            margin: 1rem 0;
            position: relative;
        }

        .date-divider::before,
        .date-divider::after {
            content: "";
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background-color: var(--third-background);
        }

        .date-divider::before {
            left: 0;
        }

        .date-divider::after {
            right: 0;
        }

        .message {
            display: flex;
            flex-direction: column;
            max-width: 80%;
        }

        .message.me {
            align-self: flex-end;
        }

        .message.other {
            align-self: flex-start;
        }

        .message-info {
            margin-bottom: 0.3rem;
        }

        .message-sender {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .bubble {
            background-color: var(--primary-color);
            padding: 0.8rem;
            border-radius: 8px;
            word-break: break-word;
        }

        .message.other .bubble {
            background-color: var(--secondary-background);
        }

        .time {
            font-size: 0.7rem;
            color: var(--secondary-text);
            margin-top: 0.3rem;
            align-self: flex-end;
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 4px;
            cursor: pointer;
        }

        .file-message {
            display: flex;
            align-items: center;
        }

        .file-icon {
            margin-right: 0.8rem;
            font-size: 1.5rem;
        }

        .file-info {
            display: flex;
            flex-direction: column;
        }

        .file-name {
            font-weight: 500;
            margin-bottom: 0.3rem;
        }

        .file-size {
            font-size: 0.8rem;
            color: var(--secondary-text);
        }

        .input-area {
            padding: 0.8rem;
            background-color: var(--background-color);
            border-top: 1px solid var(--third-background);
        }

        .message-controls {
            display: flex;
            margin-bottom: 0.5rem;
        }

        .control-btn {
            background: none;
            border: none;
            color: var(--secondary-text);
            font-size: 1.2rem;
            margin-right: 0.8rem;
            cursor: pointer;
        }

        .input-container {
            display: flex;
            align-items: flex-end;
            background-color: var(--third-background);
            border-radius: 8px;
            padding: 0 0.8rem;
        }

        #message-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--light-text);
            font-size: 1rem;
            padding: 0.8rem 0;
            max-height: 120px;
            resize: none;
        }

        #message-input:focus {
            outline: none;
        }

        #send-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1.2rem;
            padding: 0.8rem;
            cursor: pointer;
        }

        #file-input {
            display: none;
        }

        /* Emoji picker */
        .emoji-picker {
            position: absolute;
            bottom: calc(100% + 10px);
            left: 0;
            background-color: var(--secondary-background);
            border-radius: 8px;
            padding: 0.8rem;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 100;
            display: none;
        }

        .emoji {
            font-size: 1.5rem;
            cursor: pointer;
            text-align: center;
        }

        /* Account menu */
        .account-menu {
            position: absolute;
            top: 60px;
            right: 20px;
            background-color: var(--secondary-background);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 100;
            display: none;
        }

        .menu-item {
            padding: 0.8rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .menu-item:hover {
            background-color: var(--third-background);
        }

        .menu-item i {
            margin-right: 0.8rem;
            width: 20px;
            text-align: center;
        }

        .menu-item.danger {
            color: var(--danger-color);
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }

        .fullsize-image {
            max-width: 100%;
            max-height: 90vh;
        }

        .close-modal {
            position: absolute;
            top: -30px;
            right: 0;
            color: var(--light-text);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Context menu */
        .context-menu {
            position: fixed;
            background-color: var(--secondary-background);
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 100;
            display: none;
        }

        .context-item {
            padding: 0.8rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            color: var(--light-text);
        }

        .context-item:hover {
            background-color: var(--third-background);
        }

        .context-item i {
            margin-right: 0.8rem;
            width: 20px;
            text-align: center;
        }

        .context-item.danger {
            color: var(--danger-color);
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--secondary-background);
            border-radius: 4px;
            padding: 1rem;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateX(120%);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-icon {
            margin-right: 1rem;
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .notification-message {
            color: var(--secondary-text);
            font-size: 0.9rem;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%);
                width: 80%;
                max-width: 280px;
            }

            #sidebar.active {
                transform: translateX(0);
            }

            .chat-header .menu-toggle {
                display: block;
                margin-right: 0.5rem;
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 15;
            }

            .sidebar-overlay.active {
                display: block;
            }

            .emoji-picker {
                grid-template-columns: repeat(5, 1fr);
                max-width: 90vw;
            }

            .message {
                max-width: 90%;
            }

            .message-controls {
                margin-bottom: 0.3rem;
            }

            .input-area {
                padding: 0.5rem;
            }

            .notification {
                left: 20px;
                right: 20px;
                transform: translateY(120%);
            }
            
            .notification.show {
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div id="login-overlay" class="login-overlay">
        <div class="login-container">
            <h2>SecureChat Login</h2>
            <div class="login-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="Enter your username">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter your password">
                </div>
                <button id="login-btn" class="login-btn">Log In</button>
                <div id="login-error" class="login-error">Invalid username or password</div>
            </div>
        </div>
    </div>
    
    <div id="chat-container">
        <div id="sidebar">
            <div class="sidebar-header">
                <h2>SecureChat</h2>
                <p>End-to-end encrypted</p>
            </div>
            <div class="users-list">
                <!-- User list will be populated dynamically -->
            </div>
        </div>

        <div id="sidebar-overlay" class="sidebar-overlay"></div>
        
        <div class="chat-content">
            <div class="chat-header">
                <div style="display: flex; align-items: center;">
                    <button id="menu-toggle" class="menu-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1>Private Chat</h1>
                </div>
                <div class="header-controls">
                    <button class="header-btn" id="account-btn" title="Account">
                        <i class="fas fa-user-circle"></i>
                    </button>
                </div>
            </div>
            <div id="messages">
                <!-- Messages will appear here -->
            </div>
            <div class="input-area">
                <div class="message-controls">
                    <button class="control-btn" id="emoji-btn" title="Emojis">
                        <i class="far fa-smile"></i>
                    </button>
                    <button class="control-btn" id="file-btn" title="Send File">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <button class="control-btn" id="clear-chat" title="Clear Chat">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <div class="input-container">
                    <textarea id="message-input" placeholder="Type a message..." rows="1"></textarea>
                    <button id="send-btn" title="Send Message">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                    <input type="file" id="file-input" />
                </div>
            </div>
        </div>
        
        <div id="emoji-picker" class="emoji-picker">
            <span class="emoji">😀</span>
            <span class="emoji">😂</span>
            <span class="emoji">😍</span>
            <span class="emoji">😎</span>
            <span class="emoji">😊</span>
            <span class="emoji">🥰</span>
            <span class="emoji">😘</span>
            <span class="emoji">😜</span>
            <span class="emoji">😇</span>
            <span class="emoji">🤔</span>
            <span class="emoji">😴</span>
            <span class="emoji">😭</span>
            <span class="emoji">👍</span>
            <span class="emoji">❤️</span>
            <span class="emoji">💔</span>
            <span class="emoji">🔥</span>
            <span class="emoji">🎉</span>
            <span class="emoji">🙏</span>
        </div>
        
        <div id="account-menu" class="account-menu">
            <div class="menu-item danger">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </div>
        </div>
    </div>
    
    <div id="image-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <img class="fullsize-image" id="modal-image">
        </div>
    </div>
    
    <div id="context-menu" class="context-menu">
        <div class="context-item" id="context-copy">
            <i class="fas fa-copy"></i>
            Copy Message
        </div>
        <div class="context-item" id="context-reply">
            <i class="fas fa-reply"></i>
            Reply
        </div>
        <div class="context-item danger" id="context-delete">
            <i class="fas fa-trash-alt"></i>
            Delete Message
        </div>
    </div>
    
    <div id="notification" class="notification">
        <div class="notification-icon">
            <i class="fas fa-info-circle"></i>
        </div>
        <div class="notification-content">
            <div class="notification-title">Notification Title</div>
            <div class="notification-message">Notification message details here.</div>
        </div>
    </div>

<script>
// DOM elements
const loginOverlay = document.getElementById('login-overlay');
const loginBtn = document.getElementById('login-btn');
const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');
const loginError = document.getElementById('login-error');
const messagesContainer = document.getElementById('messages');
const messageInput = document.getElementById('message-input');
const sendBtn = document.getElementById('send-btn');
const emojiBtn = document.getElementById('emoji-btn');
const emojiPicker = document.getElementById('emoji-picker');
const fileInput = document.getElementById('file-input');
const fileBtn = document.getElementById('file-btn');
const clearChatBtn = document.getElementById('clear-chat');
const accountBtn = document.getElementById('account-btn');
const accountMenu = document.getElementById('account-menu');
const imageModal = document.getElementById('image-modal');
const modalImage = document.getElementById('modal-image');
const closeModal = document.querySelector('.close-modal');
const contextMenu = document.getElementById('context-menu');
const notification = document.getElementById('notification');
const usersList = document.querySelector('.users-list');
const menuToggle = document.getElementById('menu-toggle');
const sidebar = document.getElementById('sidebar');
const sidebarOverlay = document.getElementById('sidebar-overlay');

// User accounts data - encrypted with a simple obfuscation technique
const encryptedUserData = "eyJ1c2VycyI6W3sidXNlcm5hbWUiOiJUaXJ1cCIsInBhc3N3b3JkIjoiVGlydXBAMTIzIn0seyJ1c2VybmFtZSI6IlZpc2h1IiwicGFzc3dvcmQiOiJWaXNodUAxMjMifV19";

// Simple decryption function (base64 decode)
function decryptData(data) {
    try {
        return JSON.parse(atob(data));
    } catch (e) {
        console.error("Decryption error");
        return { users: [] };
    }
}

// User data
const userData = decryptData(encryptedUserData);

// Current user state
let currentUser = null;
let currentChat = null;

// Simulated users with last seen time
const users = [
    {
        id: 1,
        username: "Tirup",
        lastSeen: new Date(),
        isOnline: false,
        avatar: "T"
    },
    {
        id: 2,
        username: "Vishu",
        lastSeen: new Date(),
        isOnline: false,
        avatar: "V"
    }
];

// Login functionality
loginBtn.addEventListener('click', attemptLogin);

passwordInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        attemptLogin();
    }
});

function attemptLogin() {
    const username = usernameInput.value.trim();
    const password = passwordInput.value;
    
    const user = userData.users.find(u => 
        u.username.toLowerCase() === username.toLowerCase() && 
        u.password === password
    );
    
    if (user) {
        currentUser = users.find(u => u.username.toLowerCase() === username.toLowerCase());
        currentUser.isOnline = true;
        loginOverlay.style.display = 'none';
        
        // Update the other user in the list (the one who isn't the current user)
        const otherUser = users.find(u => u.username !== currentUser.username);
        
        // Populate the users list
        renderUsersList();
        
        // Display welcome notification
        showNotification("Welcome back!", `You're now logged in as ${currentUser.username}`);
        
        // Auto-select the chat with the other user
        if (otherUser) {
            startChat(otherUser);
        }
    } else {
        loginError.style.display = 'block';
        passwordInput.value = '';
    }
}

// Toggle sidebar for mobile
menuToggle.addEventListener('click', () => {
    sidebar.classList.add('active');
    sidebarOverlay.classList.add('active');
});

sidebarOverlay.addEventListener('click', () => {
    sidebar.classList.remove('active');
    sidebarOverlay.classList.remove('active');
});

// Render users list
function renderUsersList() {
    usersList.innerHTML = '';
    
    users.forEach(user => {
        if (user.username !== currentUser.username) {
            const userElement = document.createElement('div');
            userElement.classList.add('user-item');
            
            const statusClass = user.isOnline ? 'status-online' : 'status-offline';
            const statusText = user.isOnline ? 'Online' : `Last seen ${formatLastSeen(user.lastSeen)}`;
            
            userElement.innerHTML = `
                <div class="user-avatar">${user.avatar}</div>
                <div class="user-details">
                    <div class="user-name">${user.username}</div>
                    <div class="user-status">
                        <span class="status-indicator ${statusClass}"></span>
                        ${statusText}
                    </div>
                </div>
            `;
            
            userElement.addEventListener('click', () => {
                startChat(user);
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
            });
            
            usersList.appendChild(userElement);
        }
    });
}

// Format last seen time
function formatLastSeen(date) {
    const now = new Date();
    const diff = Math.floor((now - date) / 60000); // difference in minutes
    
    if (diff < 1) return 'just now';
    if (diff < 60) return `${diff} min ago`;
    
    const hours = Math.floor(diff / 60);
    if (hours < 24) return `${hours}h ago`;
    
    const days = Math.floor(hours / 24);
    return `${days}d ago`;
}

// Start a chat with a user
function startChat(user) {
    currentChat = user;
    document.querySelector('.chat-header h1').textContent = user.username;
    
    // Load any saved messages from local storage
    loadChatHistory(user);
    
    // Update active user in the sidebar
    document.querySelectorAll('.user-item').forEach(item => {
        item.classList.remove('active');
        if (item.querySelector('.user-name').textContent === user.username) {
            item.classList.add('active');
        }
    });
}

// Load chat history from local storage
function loadChatHistory(user) {
    // Clear messages container
    messagesContainer.innerHTML = '';
    
    // Create storage key based on the two users in the conversation
    const chatKey = getChatStorageKey(currentUser.username, user.username);
    
    // Try to load existing chat history
    const savedChat = localStorage.getItem(chatKey);
    
    if (savedChat) {
        try {
            const chatHistory = JSON.parse(savedChat);
            
            // Group messages by date
            const messagesByDate = groupMessagesByDate(chatHistory);
            
            // For each date, add divider and messages
            Object.keys(messagesByDate).forEach(dateStr => {
                // Add date divider
                addDateDivider(new Date(dateStr));
                
                // Add messages for this date
                messagesByDate[dateStr].forEach(msg => {
                    addMessage(
                        msg.content,
                        msg.sender,
                        new Date(msg.timestamp),
                        msg.sender === currentUser.username,
                        msg.type,
                        msg.fileName,
                        msg.fileSize
                    );
                });
            });
            
            // Scroll to bottom
            scrollToBottom();
        } catch (e) {
            console.error("Error loading chat history:", e);
        }
    } else {
        // If no chat history exists, display a welcome message
        const welcomeMessage = {
            content: `Welcome to your secure chat with ${user.username}. Your messages are end-to-end encrypted.`,
            sender: "System",
            timestamp: new Date(),
            type: "text"
        };
        
        addMessage(
            welcomeMessage.content,
            welcomeMessage.sender,
            welcomeMessage.timestamp,
            false,
            welcomeMessage.type
        );
    }
}

// Group messages by date
function groupMessagesByDate(messages) {
    const groups = {};
    
    messages.forEach(msg => {
        const date = new Date(msg.timestamp);
        const dateStr = date.toDateString();
        
        if (!groups[dateStr]) {
            groups[dateStr] = [];
        }
        
        groups[dateStr].push(msg);
    });
    
    return groups;
}

// Add date divider
function addDateDivider(date) {
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    let dateText;
    
    if (date.toDateString() === today.toDateString()) {
        dateText = "Today";
    } else if (date.toDateString() === yesterday.toDateString()) {
        dateText = "Yesterday";
    } else {
        dateText = date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
    }
    
    const divider = document.createElement('div');
    divider.className = 'date-divider';
    divider.textContent = dateText;
    messagesContainer.appendChild(divider);
}

// Add message to the chat
function addMessage(content, sender, timestamp, isMe = false, type = 'text', fileName = null, fileSize = null) {
    const messageEl = document.createElement('div');
    messageEl.classList.add('message');
    messageEl.classList.add(isMe ? 'me' : 'other');
    
    // Create message info (sender name)
    const messageInfo = document.createElement('div');
    messageInfo.classList.add('message-info');
    messageInfo.innerHTML = `<span class="message-sender">${sender}</span>`;
    
    // Create message bubble
    const bubble = document.createElement('div');
    bubble.classList.add('bubble');
    
    // Set content based on message type
    if (type === 'text') {
        bubble.textContent = content;
    } else if (type === 'image') {
        const img = document.createElement('img');
        img.src = content;
        img.alt = 'Image';
        img.classList.add('image-preview');
        img.addEventListener('click', () => openImageModal(content));
        bubble.appendChild(img);
    } else if (type === 'file') {
        const fileEl = document.createElement('div');
        fileEl.classList.add('file-message');
        
        fileEl.innerHTML = `
            <div class="file-icon"><i class="fas fa-file"></i></div>
            <div class="file-info">
                <div class="file-name">${fileName}</div>
                <div class="file-size">${fileSize}</div>
            </div>
        `;
        
        bubble.appendChild(fileEl);
    }
    
    // Create time element
    const timeEl = document.createElement('div');
    timeEl.classList.add('time');
    timeEl.textContent = formatTime(timestamp);
    
    // Add right-click event for context menu
    bubble.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        showContextMenu(e.pageX, e.pageY, content, messageEl);
    });
    
    // Assemble message
    messageEl.appendChild(messageInfo);
    messageEl.appendChild(bubble);
    messageEl.appendChild(timeEl);
    
    messagesContainer.appendChild(messageEl);
    
    // Scroll to the bottom after adding a message
    scrollToBottom();
}

// Format time for messages
function formatTime(date) {
    return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
}

// Save message to local storage
function saveMessage(content, sender, type = 'text', fileName = null, fileSize = null) {
    if (!currentChat) return;
    
    const chatKey = getChatStorageKey(currentUser.username, currentChat.username);
    
    // Try to load existing chat history
    let chatHistory = [];
    const savedChat = localStorage.getItem(chatKey);
    
    if (savedChat) {
        try {
            chatHistory = JSON.parse(savedChat);
        } catch (e) {
            console.error("Error parsing chat history:", e);
        }
    }
    
    // Add new message
    const newMessage = {
        content: content,
        sender: sender,
        timestamp: new Date().toISOString(),
        type: type,
        fileName: fileName,
        fileSize: fileSize
    };
    
    chatHistory.push(newMessage);
    
    // Save updated history
    localStorage.setItem(chatKey, JSON.stringify(chatHistory));
}

// Create consistent chat storage key
function getChatStorageKey(user1, user2) {
    // Sort usernames to ensure consistent key regardless of who initiated the chat
    const users = [user1, user2].sort();
    return `securechat_history_${users[0]}_${users[1]}`;
}

// Scroll to the bottom of the messages container
function scrollToBottom() {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Show context menu
function showContextMenu(x, y, messageContent, messageElement) {
    contextMenu.style.display = 'block';
    contextMenu.style.left = `${x}px`;
    contextMenu.style.top = `${y}px`;
    
    // Set up context menu actions
    document.getElementById('context-copy').onclick = () => {
        navigator.clipboard.writeText(messageContent)
            .then(() => {
                showNotification("Copied!", "Message copied to clipboard");
                hideContextMenu();
            })
            .catch(() => {
                showNotification("Error", "Failed to copy message");
                hideContextMenu();
            });
    };
    
    document.getElementById('context-reply').onclick = () => {
        messageInput.value = `@${messageElement.querySelector('.message-sender').textContent}: ${messageContent}\n`;
        messageInput.focus();
        hideContextMenu();
    };
    
    document.getElementById('context-delete').onclick = () => {
        messageElement.remove();
        hideContextMenu();
        // TODO: Also remove from localStorage
    };
}

// Hide context menu
function hideContextMenu() {
    contextMenu.style.display = 'none';
}

// Open image modal
function openImageModal(src) {
    modalImage.src = src;
    imageModal.style.display = 'flex';
}

// Show notification
function showNotification(title, message) {
    const notificationTitle = notification.querySelector('.notification-title');
    const notificationMessage = notification.querySelector('.notification-message');
    
    notificationTitle.textContent = title;
    notificationMessage.textContent = message;
    
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

// Event listeners
sendBtn.addEventListener('click', sendMessage);

messageInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// Auto-resize textarea
messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
    
    // Limit max height
    if (this.scrollHeight > 120) {
        this.style.height = '120px';
        this.style.overflowY = 'auto';
    } else {
        this.style.overflowY = 'hidden';
    }
});

// Send message function
function sendMessage() {
    const content = messageInput.value.trim();
    
    if (content && currentChat) {
        // Add message to UI
        addMessage(content, currentUser.username, new Date(), true);
        
        // Save message to storage
        saveMessage(content, currentUser.username);
        
        // Clear input
        messageInput.value = '';
        messageInput.style.height = 'auto';
        
        // Simulate response after a short delay
        setTimeout(() => {
            if (Math.random() > 0.5) {
                const responses = [
                    "Got it, thanks for the update.",
                    "I'll check and get back to you.",
                    "That sounds good!",
                    "Can you provide more details?",
                    "I'll work on this right away.",
                    "Let's discuss this further tomorrow."
                ];
                
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                
                // Add response to UI
                addMessage(randomResponse, currentChat.username, new Date(), false);
                
                // Save response to storage
                saveMessage(randomResponse, currentChat.username);
            }
        }, 2000 + Math.random() * 2000);
    }
}

// Emoji picker
emojiBtn.addEventListener('click', () => {
    const isVisible = emojiPicker.style.display === 'grid';
    emojiPicker.style.display = isVisible ? 'none' : 'grid';
    
    if (!isVisible) {
        const inputRect = document.querySelector('.input-container').getBoundingClientRect();
        emojiPicker.style.left = `${inputRect.left}px`;
    }
});

// Add emoji to message input when clicked
document.querySelectorAll('.emoji').forEach(emoji => {
    emoji.addEventListener('click', () => {
        messageInput.value += emoji.textContent;
        emojiPicker.style.display = 'none';
        messageInput.focus();
    });
});

// File input handling
fileBtn.addEventListener('click', () => {
    fileInput.click();
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        const file = e.target.files[0];
        
        if (file.type.startsWith('image/')) {
            // Handle image file
            const reader = new FileReader();
            
            reader.onload = function(event) {
                // Add message to UI
                addMessage(event.target.result, currentUser.username, new Date(), true, 'image');
                
                // Save message to storage
                saveMessage(event.target.result, currentUser.username, 'image');
            };
            
            reader.readAsDataURL(file);
        } else {
            // Handle other file types
            const fileSize = formatFileSize(file.size);
            
            // Add message to UI
            addMessage(file.name, currentUser.username, new Date(), true, 'file', file.name, fileSize);
            
            // Save message to storage
            saveMessage(file.name, currentUser.username, 'file', file.name, fileSize);
        }
        
        // Clear file input
        fileInput.value = '';
    }
});

// Format file size
function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    else return (bytes / 1048576).toFixed(1) + ' MB';
}

// Clear chat
clearChatBtn.addEventListener('click', () => {
    if (currentChat) {
        messagesContainer.innerHTML = '';
        
        // Clear from localStorage
        const chatKey = getChatStorageKey(currentUser.username, currentChat.username);
        localStorage.removeItem(chatKey);
        
        showNotification("Chat Cleared", "Chat history has been cleared");
    }
});

// Close modal
closeModal.addEventListener('click', () => {
    imageModal.style.display = 'none';
});

// Account menu
accountBtn.addEventListener('click', () => {
    const isVisible = accountMenu.style.display === 'block';
    accountMenu.style.display = isVisible ? 'none' : 'block';
});

// Logout
accountMenu.querySelector('.menu-item').addEventListener('click', () => {
    // Set current user as offline
    if (currentUser) {
        currentUser.isOnline = false;
        currentUser.lastSeen = new Date();
    }
    
    // Reset current user and chat
    currentUser = null;
    currentChat = null;
    
    // Show login overlay
    loginOverlay.style.display = 'flex';
    accountMenu.style.display = 'none';
    
    // Clear inputs
    usernameInput.value = '';
    passwordInput.value = '';
    loginError.style.display = 'none';
});

// Close menus when clicking elsewhere
document.addEventListener('click', (e) => {
    // Close emoji picker if open and clicked outside
    if (emojiPicker.style.display === 'grid' && 
        !emojiBtn.contains(e.target) && 
        !emojiPicker.contains(e.target)) {
        emojiPicker.style.display = 'none';
    }
    
    // Close account menu if open and clicked outside
    if (accountMenu.style.display === 'block' && 
        !accountBtn.contains(e.target) && 
        !accountMenu.contains(e.target)) {
        accountMenu.style.display = 'none';
    }
    
    // Close context menu if open and clicked outside
    if (contextMenu.style.display === 'block' && 
        !contextMenu.contains(e.target)) {
        hideContextMenu();
    }
});

// Close modal when clicking outside
window.addEventListener('click', (e) => {
    if (e.target === imageModal) {
        imageModal.style.display = 'none';
    }
});

// Initialize app
document.addEventListener('DOMContentLoaded', () => {
    // Focus username input on load
    usernameInput.focus();
});
</script>
</body>
</html>
