<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Chat</title>
    <style>
        :root {
            --primary-color: #3a86ff;
            --primary-hover: #2a75ed;
            --secondary-color: #8338ec;
            --bubble-me: #e0f2ff;
            --bubble-other: #f0f0f0;
            --background: #f8fafc;
            --card: #ffffff;
            --text: #333333;
            --text-light: #666666;
            --border: #e1e5eb;
        }

        [data-theme="dark"] {
            --primary-color: #3a86ff;
            --primary-hover: #2a75ed;
            --secondary-color: #8338ec;
            --bubble-me: #1e293b;
            --bubble-other: #334155;
            --background: #0f172a;
            --card: #1e293b;
            --text: #e2e8f0;
            --text-light: #94a3b8;
            --border: #334155;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background: var(--background);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: var(--text);
            transition: background 0.3s ease;
        }

        #chat-container {
            background-color: var(--card);
            border-radius: 16px;
            width: 450px;
            max-width: 100%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            height: 85vh;
            max-height: 700px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 16px;
        }

        .chat-header h1 {
            font-size: 18px;
            margin: 0;
            font-weight: 600;
        }
        
        .header-controls {
            display: flex;
            gap: 10px;
        }
        
        .header-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 8px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 16px;
            transition: background 0.2s;
        }
        
        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
        }

        .message {
            display: flex;
            flex-direction: column;
            max-width: 75%;
            word-break: break-word;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message .bubble {
            padding: 12px 16px;
            border-radius: 18px;
            background: var(--bubble-other);
            position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            color: var(--text);
            line-height: 1.5;
        }

        .message.me {
            align-self: flex-end;
        }

        .message.me .bubble {
            background: var(--bubble-me);
            border-bottom-right-radius: 4px;
        }
        
        .message.other .bubble {
            border-bottom-left-radius: 4px;
        }

        .message-info {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-light);
            margin-top: 4px;
            padding: 0 4px;
        }
        
        .message.me .message-info {
            flex-direction: row-reverse;
        }
        
        .sender-name {
            font-weight: 600;
        }

        .file-message {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-icon {
            font-size: 24px;
        }

        .file-info {
            display: flex;
            flex-direction: column;
        }

        .file-name {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .file-size {
            font-size: 12px;
            color: var(--text-light);
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .image-preview:hover {
            transform: scale(1.02);
        }

        .input-area {
            padding: 15px;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            background-color: var(--card);
        }

        .message-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .control-btn {
            padding: 8px;
            background: rgba(0, 0, 0, 0.05);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text);
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            transition: background 0.2s;
        }

        .control-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        #message-input {
            flex: 1;
            padding: 14px 18px;
            border-radius: 24px;
            border: 1px solid var(--border);
            font-size: 15px;
            resize: none;
            max-height: 120px;
            min-height: 50px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: var(--card);
            color: var(--text);
        }

        #message-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(58, 134, 255, 0.1);
        }

        #send-btn {
            padding: 0;
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            width: 50px;
            height: 50px;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.2s;
        }

        #send-btn:hover {
            background-color: var(--primary-hover);
            transform: scale(1.05);
        }

        #send-icon {
            width: 20px;
            height: 20px;
        }

        #file-input {
            display: none;
        }

        .emoji-picker {
            display: none;
            position: absolute;
            bottom: 100px;
            left: 20px;
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            z-index: 10;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            max-width: 320px;
        }

        .emoji {
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px;
            border-radius: 8px;
            transition: background 0.2s, transform 0.2s;
        }

        .emoji:hover {
            background: rgba(0, 0, 0, 0.05);
            transform: scale(1.1);
        }
        
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .login-container {
            background: var(--card);
            padding: 30px;
            border-radius: 16px;
            width: 320px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            animation: fadeInUp 0.5s ease;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .login-header h2 {
            color: var(--text);
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .login-header p {
            color: var(--text-light);
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
        }
        
        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 15px;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: var(--card);
            color: var(--text);
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(58, 134, 255, 0.1);
        }
        
        .login-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.2s, transform 0.1s;
        }
        
        .login-btn:hover {
            background: var(--primary-hover);
        }
        
        .login-btn:active {
            transform: scale(0.98);
        }
        
        .account-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .account-option {
            flex: 1;
            background: rgba(0, 0, 0, 0.03);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s, transform 0.1s;
        }
        
        .account-option.selected {
            border-color: var(--primary-color);
            background: rgba(58, 134, 255, 0.05);
        }
        
        .account-option:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }
        
        .account-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
            margin: 0 auto 8px;
        }
        
        .account-name {
            font-weight: 600;
            color: var(--text);
        }
        
        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px 0 5px;
        }
        
        .theme-toggle span {
            font-size: 13px;
            color: var(--text-light);
            margin-right: 8px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        
        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: var(--card);
            padding: 20px;
            border-radius: 16px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 22px;
            cursor: pointer;
            color: var(--text);
            z-index: 10;
            background: var(--card);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .fullsize-image {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 8px;
        }
        
        .date-divider {
            display: flex;
            align-items: center;
            margin: 10px 0;
            color: var(--text-light);
            font-size: 12px;
            text-align: center;
        }
        
        .date-divider::before,
        .date-divider::after {
            content: "";
            flex: 1;
            border-bottom: 1px solid var(--border);
        }
        
        .date-divider::before {
            margin-right: 10px;
        }
        
        .date-divider::after {
            margin-left: 10px;
        }
        
        .typing-indicator {
            display: none;
            align-self: flex-start;
            background: var(--bubble-other);
            padding: 12px 16px;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            margin-top: 5px;
            color: var(--text);
            font-size: 14px;
            animation: fadeIn 0.3s ease;
        }
        
        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: var(--text-light);
            border-radius: 50%;
            margin: 0 1px;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        
        @media (max-width: 480px) {
            #chat-container {
                height: 100vh;
                max-height: none;
                width: 100%;
                border-radius: 0;
            }
            
            .chat-header {
                border-radius: 0;
            }
            
            body {
                padding: 0;
            }
            
            .message {
                max-width: 85%;
            }
        }
        
        #logout-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 14px;
            transition: background 0.2s;
            margin-left: 8px;
        }
        
        #logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .encrypted-badge {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(0, 0, 0, 0.07);
            border-radius: 12px;
            font-size: 12px;
            color: var(--text-light);
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div id="login-overlay" class="login-overlay">
        <div class="login-container">
            <div class="login-header">
                <h2>Secure Chat</h2>
                <p>Select an account to continue</p>
            </div>
            
            <div class="account-selector">
                <div class="account-option" data-username="Vishu">
                    <div class="account-avatar">V</div>
                    <div class="account-name">Vishu</div>
                </div>
                <div class="account-option" data-username="Tirup">
                    <div class="account-avatar">T</div>
                    <div class="account-name">Tirup</div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="password-input">Password</label>
                <input type="password" id="password-input" placeholder="Enter your password">
            </div>
            
            <button id="login-btn" class="login-btn">Login</button>
            
            <div class="theme-toggle">
                <span>Dark Mode</span>
                <label class="switch">
                    <input type="checkbox" id="theme-switch">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>
    
    <div id="chat-container">
        <div class="chat-header">
            <div class="user-info">
                <div class="avatar" id="user-avatar"></div>
                <h1 id="header-title">Secure Chat</h1>
            </div>
            <div class="header-controls">
                <button class="header-btn" id="toggle-theme" title="Toggle Theme">🌙</button>
                <button class="header-btn" id="clear-chat" title="Clear Chat">🗑️</button>
                <button id="logout-btn">Logout</button>
            </div>
        </div>
        <div id="messages"></div>
        <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="input-area">
            <div class="message-controls">
                <button class="control-btn" id="emoji-btn" title="Emojis">😊</button>
                <button class="control-btn" id="file-btn" title="Send File">📎</button>
            </div>
            <div class="input-container">
                <textarea id="message-input" placeholder="Type your message..." rows="1"></textarea>
                <button id="send-btn" title="Send Message">
                    <svg id="send-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
                <input type="file" id="file-input" />
            </div>
            <div class="encrypted-badge">
                <span>🔒</span>
                <span>End-to-end encrypted</span>
            </div>
        </div>
        <div id="emoji-picker" class="emoji-picker" style="display: none;">
            <span class="emoji">😀</span>
            <span class="emoji">😂</span>
            <span class="emoji">😍</span>
            <span class="emoji">😎</span>
            <span class="emoji">😊</span>
            <span class="emoji">🥰</span>
            <span class="emoji">😘</span>
            <span class="emoji">😜</span>
            <span class="emoji">😇</span>
            <span class="emoji">🤔</span>
            <span class="emoji">😴</span>
            <span class="emoji">😭</span>
            <span class="emoji">👍</span>
            <span class="emoji">❤️</span>
            <span class="emoji">💔</span>
            <span class="emoji">💯</span>
            <span class="emoji">🔥</span>
            <span class="emoji">💋</span>
            <span class="emoji">🙌</span>
            <span class="emoji">💪</span>
            <span class="emoji">🎉</span>
            <span class="emoji">🌹</span>
            <span class="emoji">💰</span>
            <span class="emoji">🍕</span>
        </div>
    </div>
    
    <div id="image-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <img class="fullsize-image" id="modal-image">
        </div>
    </div>

    <script>
        // Prevent viewing source code
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.onkeydown = function(e) {
            // Disable F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
            if (
                e.keyCode === 123 || 
                (e.ctrlKey && e.shiftKey && e.keyCode === 73) || 
                (e.ctrlKey && e.shiftKey && e.keyCode === 74) || 
                (e.ctrlKey && e.keyCode === 85)
            ) {
                return false;
            }
        };
        
        // Simple encryption/decryption function
        function encrypt(text, key) {
            let result = '';
            for (let i = 0; i < text.length; i++) {
                const charCode = text.charCodeAt(i);
                const keyChar = key.charCodeAt(i % key.length);
                result += String.fromCharCode(charCode ^ keyChar);
            }
            return btoa(result); // Base64 encode for safe storage
        }
        
        function decrypt(encoded, key) {
            try {
                const text = atob(encoded); // Base64 decode
                let result = '';
                for (let i = 0; i < text.length; i++) {
                    const charCode = text.charCodeAt(i);
                    const keyChar = key.charCodeAt(i % key.length);
                    result += String.fromCharCode(charCode ^ keyChar);
                }
                return result;
            } catch (e) {
                console.error("Decryption failed");
                return "Unable to decrypt message";
            }
        }

        // DOM elements
        const loginOverlay = document.getElementById('login-overlay');
        const passwordInput = document.getElementById('password-input');
        const loginBtn = document.getElementById('login-btn');
        const accountOptions = document.querySelectorAll('.account-option');
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const emojiBtn = document.getElementById('emoji-btn');
        const emojiPicker = document.getElementById('emoji-picker');
        const fileInput = document.getElementById('file-input');
        const fileBtn = document.getElementById('file-btn');
        const clearChatBtn = document.getElementById('clear-chat');
        const logoutBtn = document.getElementById('logout-btn');
        const imageModal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        const closeModal = document.querySelector('.close-modal');
        const headerTitle = document.getElementById('header-title');
        const userAvatar = document.getElementById('user-avatar');
        const themeSwitch = document.getElementById('theme-switch');
        const toggleTheme = document.getElementById('toggle-theme');
        const typingIndicator = document.querySelector('.typing-indicator');
        
        // State variables
        let currentUser = '';
        let encryptionKey = '';
        const accounts = {
            'Vishu': 'Vishu',
            'Tirup': 'Tirup'
        };
        
        // Theme handling
        function initTheme() {
            const savedTheme = localStorage.getItem('chatTheme');
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                themeSwitch.checked = true;
                toggleTheme.textContent = '☀️';
            } else {
                document.body.removeAttribute('data-theme');
                themeSwitch.checked = false;
                toggleTheme.textContent = '🌙';
            }
        }
        
        themeSwitch.addEventListener('change', function() {
            toggleThemeMode();
        });
        
        toggleTheme.addEventListener('click', function() {
            toggleThemeMode();
        });
        
        function toggleThemeMode() {
            if (document.body.getAttribute('data-theme') === 'dark') {
                document.body.removeAttribute('data-theme');
                localStorage.setItem('chatTheme', 'light');
                themeSwitch.checked = false;
                toggleTheme.textContent = '🌙';
            } else {
                document.body.setAttribute('data-theme', 'dark');
                localStorage.setItem('chatTheme', 'dark');
                themeSwitch.checked = true;
                toggleTheme.textContent = '☀️';
            }
        }
        
        // Initialize theme
        initTheme();
        
        // Account selection
        accountOptions.forEach(option => {
            option.addEventListener('click', function() {
                accountOptions.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                currentUser = this.getAttribute('data-username');
                passwordInput.focus();
            });
        });
        
        // Login handling
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });
        
        loginBtn.addEventListener('click', handleLogin);
        
        function handleLogin() {
            if (!currentUser) {
                alert('Please select an account');
                return;
            }
            
            const password = passwordInput.value;
            
            if (accounts[currentUser] === password) {
                encryptionKey = password; // Use password as encryption key
                loginOverlay.style.display = 'none';
                
                // Set up user info
                headerTitle.textContent = `Chat as ${currentUser}`;
                userAvatar.textContent = currentUser.charAt(0);
                
// Load saved messages
function loadMessages() {
    const savedMessages = localStorage.getItem(`chatMessages_${currentUser}`);
    if (savedMessages) {
        try {
            const messages = JSON.parse(savedMessages);
            messages.forEach(msg => {
                if (msg.type === 'text') {
                    addMessage(msg.sender, decrypt(msg.content, encryptionKey), msg.time);
                } else if (msg.type === 'file') {
                    addFileMessage(msg.sender, msg.fileName, msg.fileSize, msg.time);
                } else if (msg.type === 'image') {
                    addImageMessage(msg.sender, msg.content, msg.time);
                }
            });
            scrollToBottom();
        } catch (e) {
            console.error("Failed to load messages", e);
        }
    } else {
        // Add welcome message for new users
        const welcomeMsg = "Welcome to Secure Chat! Your messages are end-to-end encrypted.";
        addMessage('system', welcomeMsg, new Date().toISOString());
        saveMessages();
    }
}

// Save messages to localStorage
function saveMessages() {
    const messages = [];
    const messageElements = messagesContainer.querySelectorAll('.message');
    
    messageElements.forEach(el => {
        const sender = el.classList.contains('me') ? currentUser : el.getAttribute('data-sender');
        const time = el.querySelector('.message-time').textContent;
        
        if (el.querySelector('.file-message')) {
            // File message
            const fileName = el.querySelector('.file-name').textContent;
            const fileSize = el.querySelector('.file-size').textContent;
            messages.push({
                type: 'file',
                sender,
                fileName,
                fileSize,
                time
            });
        } else if (el.querySelector('.image-preview')) {
            // Image message
            const imgSrc = el.querySelector('.image-preview').src;
            messages.push({
                type: 'image',
                sender,
                content: imgSrc,
                time
            });
        } else {
            // Text message
            const content = el.querySelector('.bubble').textContent;
            messages.push({
                type: 'text',
                sender,
                content: encrypt(content, encryptionKey),
                time
            });
        }
    });
    
    localStorage.setItem(`chatMessages_${currentUser}`, JSON.stringify(messages));
}

// Add a text message to the chat
function addMessage(sender, text, time = new Date().toISOString()) {
    const isMe = sender === currentUser;
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isMe ? 'me' : 'other'}`;
    if (!isMe) messageDiv.setAttribute('data-sender', sender);
    
    const formattedDate = formatTime(time);
    
    messageDiv.innerHTML = `
        <div class="bubble">${text}</div>
        <div class="message-info">
            <span class="sender-name">${isMe ? 'You' : sender}</span>
            <span class="message-time">${formattedDate}</span>
        </div>
    `;
    
    // Check if we need to add a date divider
    addDateDividerIfNeeded(time);
    
    messagesContainer.appendChild(messageDiv);
    scrollToBottom();
    saveMessages();
}

// Add a file message
function addFileMessage(sender, fileName, fileSize, time = new Date().toISOString()) {
    const isMe = sender === currentUser;
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isMe ? 'me' : 'other'}`;
    if (!isMe) messageDiv.setAttribute('data-sender', sender);
    
    const formattedDate = formatTime(time);
    
    messageDiv.innerHTML = `
        <div class="bubble">
            <div class="file-message">
                <div class="file-icon">📄</div>
                <div class="file-info">
                    <div class="file-name">${fileName}</div>
                    <div class="file-size">${fileSize}</div>
                </div>
            </div>
        </div>
        <div class="message-info">
            <span class="sender-name">${isMe ? 'You' : sender}</span>
            <span class="message-time">${formattedDate}</span>
        </div>
    `;
    
    addDateDividerIfNeeded(time);
    messagesContainer.appendChild(messageDiv);
    scrollToBottom();
    saveMessages();
}

// Add an image message
function addImageMessage(sender, imgSrc, time = new Date().toISOString()) {
    const isMe = sender === currentUser;
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isMe ? 'me' : 'other'}`;
    if (!isMe) messageDiv.setAttribute('data-sender', sender);
    
    const formattedDate = formatTime(time);
    
    messageDiv.innerHTML = `
        <div class="bubble">
            <img src="${imgSrc}" class="image-preview">
        </div>
        <div class="message-info">
            <span class="sender-name">${isMe ? 'You' : sender}</span>
            <span class="message-time">${formattedDate}</span>
        </div>
    `;
    
    addDateDividerIfNeeded(time);
    messagesContainer.appendChild(messageDiv);
    
    // Add click event for image preview
    const imagePreview = messageDiv.querySelector('.image-preview');
    imagePreview.addEventListener('click', function() {
        modalImage.src = this.src;
        imageModal.style.display = 'flex';
    });
    
    scrollToBottom();
    saveMessages();
}

// Add date divider if needed
function addDateDividerIfNeeded(timeStr) {
    const date = new Date(timeStr);
    const dateStr = date.toLocaleDateString();
    
    const lastDivider = messagesContainer.querySelector('.date-divider:last-of-type');
    const lastDividerDate = lastDivider ? lastDivider.getAttribute('data-date') : null;
    
    if (!lastDivider || lastDividerDate !== dateStr) {
        const divider = document.createElement('div');
        divider.className = 'date-divider';
        divider.setAttribute('data-date', dateStr);
        divider.textContent = formatDate(date);
        messagesContainer.appendChild(divider);
    }
}

// Format time to a readable string
function formatTime(timeStr) {
    const date = new Date(timeStr);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

// Format date to a readable string
function formatDate(date) {
    const today = new Date();
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    
    if (date.toDateString() === today.toDateString()) {
        return 'Today';
    } else if (date.toDateString() === yesterday.toDateString()) {
        return 'Yesterday';
    } else {
        return date.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });
    }
}

// Scroll to bottom of messages
function scrollToBottom() {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Send a message
function sendMessage() {
    const text = messageInput.value.trim();
    if (text) {
        addMessage(currentUser, text);
        messageInput.value = '';
        messageInput.style.height = 'auto';
        
        // Simulate another user responding after a delay
        simulateResponse();
    }
}

// Simulate response from other user
function simulateResponse() {
    const otherUser = currentUser === 'Vishu' ? 'Tirup' : 'Vishu';
    
    // Show typing indicator
    typingIndicator.style.display = 'block';
    scrollToBottom();
    
    // Random delay between 1-3 seconds
    const delay = Math.floor(Math.random() * 2000) + 1000;
    
    setTimeout(() => {
        typingIndicator.style.display = 'none';
        
        const responses = [
            "Hey, how's it going?",
            "Did you finish that project?",
            "I'm working on the new designs.",
            "Can we meet later today?",
            "Thanks for the update!",
            "Let me check and get back to you.",
            "That sounds interesting!",
            "I'll send you the files soon.",
            "Have you seen the latest report?",
            "Good idea, let's do that."
        ];
        
        const randomResponse = responses[Math.floor(Math.random() * responses.length)];
        addMessage(otherUser, randomResponse);
    }, delay);
}

// Handle sending message on button click
sendBtn.addEventListener('click', sendMessage);

// Handle sending message on Enter key (without shift)
messageInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// Auto-resize textarea
messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
});

// Emoji picker
emojiBtn.addEventListener('click', function() {
    emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'grid' : 'none';
});

// Handle emoji selection
document.querySelectorAll('.emoji').forEach(emoji => {
    emoji.addEventListener('click', function() {
        messageInput.value += this.textContent;
        messageInput.focus();
        emojiPicker.style.display = 'none';
    });
});

// Close emoji picker when clicking outside
document.addEventListener('click', function(e) {
    if (!emojiBtn.contains(e.target) && !emojiPicker.contains(e.target)) {
        emojiPicker.style.display = 'none';
    }
});

// File upload
fileBtn.addEventListener('click', function() {
    fileInput.click();
});

fileInput.addEventListener('change', function() {
    if (this.files && this.files[0]) {
        const file = this.files[0];
        
        // Check if it's an image
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                addImageMessage(currentUser, e.target.result);
            };
            reader.readAsDataURL(file);
        } else {
            // Handle as regular file
            const size = file.size < 1024 ? file.size + ' B' : 
                      file.size < 1048576 ? (file.size / 1024).toFixed(1) + ' KB' : 
                      (file.size / 1048576).toFixed(1) + ' MB';
                      
            addFileMessage(currentUser, file.name, size);
        }
        
        // Reset file input
        this.value = '';
    }
});

// Clear chat
clearChatBtn.addEventListener('click', function() {
    if (confirm('Are you sure you want to clear all messages?')) {
        messagesContainer.innerHTML = '';
        localStorage.removeItem(`chatMessages_${currentUser}`);
        
        // Add welcome message again
        const welcomeMsg = "Chat cleared. Your messages are end-to-end encrypted.";
        addMessage('system', welcomeMsg);
    }
});

// Logout
logoutBtn.addEventListener('click', function() {
    loginOverlay.style.display = 'flex';
    currentUser = '';
    encryptionKey = '';
    messagesContainer.innerHTML = '';
    passwordInput.value = '';
    accountOptions.forEach(opt => opt.classList.remove('selected'));
});

// Image modal
closeModal.addEventListener('click', function() {
    imageModal.style.display = 'none';
});

imageModal.addEventListener('click', function(e) {
    if (e.target === imageModal) {
        imageModal.style.display = 'none';
    }
});

// Close image modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && imageModal.style.display === 'flex') {
        imageModal.style.display = 'none';
    }
});
</script>
</body>
</html>
